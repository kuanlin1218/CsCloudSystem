<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <title>è©®æ ©é›²ç³»çµ±</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="å…±ç”¨é¢¨æ ¼.css">
  <link id="dynamic-favicon" rel="icon" type="image/x-icon">

  <style>
    body {
        height: 100%;
        margin: 0;
        background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
    }

    .input-group-text {
      color: rgb(12, 44, 228);
    }

    .sel {
      color: rgb(217, 12, 228);
    }

    .btn-ç¶  {
      width:100%; /*å¯¬åº¦*/
      font-size:22px; /*æ–‡å­—å¤§å°*/
      padding:5px;
      letter-spacing: 8px; /*æ–‡å­—é–“è·*/
      font-weight:600; /*å­—é«”ç²—ç´°100-900*/ 
    }

    .custom-t {
      height: 45px;
    }
    .custom-c {
      background-color: none; 
      text-align: left; /*æ–‡å­—ç½®ä¸­*/
      appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ (é¸ç”¨) */
      font-size: 18px; 
      height: 45px;
    }

  </style>
</head>

<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="é¦–é .html">
        <img id="brandLogo" alt="Logo" class="navbar-logo">
        è©®æ ©CNCé›²ç«¯ç³»çµ±
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ›å°è¦½åˆ—">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="é¦–é .html">ğŸ  é¦–é </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åˆ€å…·å…¥åº«.html">ğŸ›’ åˆ€å…·å…¥åº«</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åˆ€å…·æŸ¥è©¢.html">ğŸ” åˆ€å…·æŸ¥è©¢</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åŠ å·¥æ•¸é‡ç™»è¨˜.html">ğŸ“‹ åŠ å·¥æ•¸é‡ç™»è¨˜</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åŠ å·¥æ•¸é‡æŸ¥è©¢.html">ğŸ‘¨ğŸ»â€ğŸ’» åŠ å·¥æ•¸é‡æŸ¥è©¢</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ç¬¬1éƒ¨åˆ†--æ•¸é‡ç™»è¨˜ -->
  <div class="container">
    <form action="" id="stockForm">
      <h2> ğŸ›’ CNCåˆ€å…·å…¥åº« ğŸ›’ </h2>
      <hr>
      <!-- é¡åˆ¥ -->
      <div class="input-group my-3">
        <span class="input-group-text">é¡åˆ¥</span>
        <select name="category" id="category" class="form-select custom" required></select>
      </div>

      <!-- å½¢ç‹€ -->
      <div class="input-group my-3">
        <span class="input-group-text sel">å½¢ç‹€</span>
        <input list="shapeList" id="shape" name="shape" class="form-control custom" required>
        <datalist id="shapeList"></datalist>
      </div>
      <!-- å°ºå¯¸ -->
      <div class="input-group my-3">
        <span class="input-group-text sel">å°ºå¯¸</span>
        <input list="sizeList" id="size" name="size" class="form-control custom" >
        <datalist id="sizeList"></datalist>
      </div>
      <!-- æ§½å‹ -->
      <div class="input-group my-3">
        <span class="input-group-text sel">æ§½å‹</span>
        <input list="GrooveList" id="groove" name="groove" class="form-control custom" >
        <datalist id="GrooveList"></datalist>
      </div>
      <!-- æè³ª -->
      <div class="input-group my-3">
        <span class="input-group-text sel">æè³ª</span>
        <input list="MaterialList" id="material" name="material" class="form-control custom" required>
        <datalist id="MaterialList"></datalist>
      </div>

      <!-- å“åè¦æ ¼ -->
      <div class="input-group my-3 position-relative">
        <span class="input-group-text">å“åè¦æ ¼</span>
        <input name="spec" id="specInput" class="form-control custom" autocomplete="off" required>
        <!-- è‡ªå‹•å®Œæˆæç¤º -->
        <ul id="specSuggestions" class="list-group position-absolute w-100 z-3"
        style="top:100%; display:none; max-height:200px; overflow-y:auto;"></ul>
      </div>
      
      <!-- å» ç‰Œ -->
      <div class="input-group my-3">
        <span class="input-group-text">å» ç‰Œ</span>
        <input list="brandList" id="brand" name="brand" class="form-control custom" required>
        <datalist id="brandList"></datalist>
      </div>
      <!-- å» å•† -->
      <div class="input-group my-3">
        <span class="input-group-text">å» å•†</span>
        <input list="vendorList" id="vendor" name="vendor" class="form-control custom" required>
        <datalist id="vendorList"></datalist>
      </div>
      <!-- å–®åƒ¹ï¼Œæ•¸é‡ -->
      <div class="input-group my-3">
        <span class="input-group-text">å–®åƒ¹</span>
        <input type="number" inputmode="decimal" pattern="[0-9]*" name="unit_price" id="unit_price" class="form-control custom" required>
        <span class="input-group-text">æ•¸é‡</span>
        <input type="number" inputmode="decimal" pattern="[0-9]*" name="quantity" id="quantity" class="form-control custom" required>
      </div>
      <!-- ç¸½åƒ¹ -->
      <div class="input-group my-3">
        <span class="input-group-text">ç¸½åƒ¹</span>
        <input type="text" name="total_price" id="total_price" class="form-control custom" required readonly>
      </div>
      <!-- æ—¥æœŸ -->
      <div class="input-group my-3">
        <span class="input-group-text">æ—¥æœŸ</span>
        <input type="date" name="date" id="date" class="form-control custom" placeholder="YYYY/MM/DD" required>
      </div>
      <!-- å‚™è¨» -->
      <div class="input-group my-3">
        <span class="input-group-text custom-t">å‚™è¨»</span>
        <textarea class="form-control custom-c" name="note" id="note" rows="1"></textarea>
      </div>

      <!-- é€å‡ºä¸­æç¤º -->
      <div id="loading" class="text-center my-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">é€å‡ºä¸­...</span>
        </div>
        <div>é€å‡ºä¸­ï¼Œè«‹ç¨å€™...</div>
      </div>
      
      <!-- é€å‡º -->
      <div class="row">
        <div class="col-sm-12">
          <button type="submit" id="submitButton" class="btn btn-ç¶  my-2">
            é€å‡º
          </button>
        </div>
      </div>
    </form>
    <hr>
    
    <!-- é¡¯ç¤ºè¡¨æ ¼å…§å®¹ -->
    <div class="table-container" id="result"></div>
    <br>
  </div>

<script>
  // å…¨åŸŸè®Šæ•¸èˆ‡å…ƒç´ å¿«å–
  const categoryEl = document.getElementById("category");
  const shapeEl = document.getElementById("shape");
  const sizeEl = document.getElementById("size");
  const grooveEl = document.getElementById("groove");
  const materialEl = document.getElementById("material");
  const specEl = document.getElementById("specInput");
  const brandLogoEl = document.getElementById("brandLogo");
  const faviconEl = document.getElementById("dynamic-favicon");

  let allSpecs = [];

  // åˆå§‹åŒ–é é¢ï¼ˆè¨­å®š logoã€æ—¥æœŸã€è¼‰å…¥ä¸‹æ‹‰é¸å–®ã€æ›äº‹ä»¶ï¼‰
  document.addEventListener("DOMContentLoaded", () => {
    brandLogoEl.src = LOGO_URL;
    faviconEl.href = FAVICON_URL;
    setTodayDate();
    loadDropdownData();
    setupFormListeners();
    setupSpecSuggestion();
  });

  // ğŸ“† è¨­å®šä»Šå¤©æ—¥æœŸç‚ºé è¨­å€¼
  function setTodayDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
  }

  // ğŸ”½ è¼‰å…¥é¡åˆ¥ã€å» ç‰Œã€å» å•†ã€å“åè¦æ ¼ï¼ˆå…¨éƒ¨ï¼‰
  function loadDropdownData() {
    fetch(`${scriptUrl}?page=inventory`)
      .then(res => res.json())
      .then(data => {
        fillSelect('category', data.categories);
        fillDatalist("brandList", data.brands);
        fillDatalist("vendorList", data.vendors);
        allSpecs = data.specs || [];

        // è‹¥å·²æœ‰é è¨­é¡åˆ¥ï¼Œè§¸ç™¼è®Šæ›´
        if (categoryEl.value) {
          categoryEl.dispatchEvent(new Event("change"));
        }
      })
      .catch(err => {
        console.error('è¼‰å…¥é¸å–®è³‡æ–™å¤±æ•—ï¼š', err);
        document.getElementById('result').innerHTML = `<p class="text-danger">è¼‰å…¥é¸å–®è³‡æ–™å¤±æ•—</p>`;
      });
  }

  // ğŸ§¾ å°‡é¸é …å¡«å…¥ <select>
  function fillSelect(id, options) {
    const select = document.getElementById(id);
    select.innerHTML = "";
    options.forEach(opt => {
      const option = document.createElement("option");
      option.value = opt;
      option.text = opt;
      select.appendChild(option);
    });
  }

  // ğŸ§¾ å°‡é¸é …å¡«å…¥ <datalist>
  function fillDatalist(id, options) {
    const datalist = document.getElementById(id);
    datalist.innerHTML = "";
    options.forEach(opt => {
      const option = document.createElement("option");
      option.value = opt;
      datalist.appendChild(option);
    });
  }

  // ğŸ§¼ æ›´æ–° datalistï¼Œå»é™¤é‡è¤‡ã€æ’åº
  function updateDatalist(id, list) {
    const datalist = document.getElementById(id);
    datalist.innerHTML = "";
    [...new Set(list.filter(v => v))]
      .map(v => String(v))
      .sort((a, b) => a.localeCompare(b))
      .forEach(val => {
        const option = document.createElement("option");
        option.value = val;
        datalist.appendChild(option);
      });
  }

  // ğŸ“Œ é¡åˆ¥è®Šæ›´ï¼šè¼‰å…¥è©²é¡åˆ¥å°æ‡‰çš„ specsã€å½¢ç‹€ã€æ§½å‹ã€æè³ªï¼Œä¸¦é¡¯ç¤ºæ¬„ä½
  categoryEl.addEventListener("change", async function () {
    const category = this.value;

    resetFormInputs();
    toggleInputGroups(category);

    try {
      const [specRes, fieldRes] = await Promise.all([
        fetch(`${scriptUrl}?page=inventory&category=${encodeURIComponent(category)}`).then(r => r.json()),
        fetch(`${scriptUrl}?page=load_tool_fields&category=${encodeURIComponent(category)}`).then(r => r.json())
      ]);

      allSpecs = specRes.specs || [];
      updateDatalist("shapeList", fieldRes.shape);
      updateDatalist("MaterialList", fieldRes.material);

      if (category === "A.åˆ€ç‰‡") {
        updateDatalist("GrooveList", fieldRes.groove);
      } else {
        document.getElementById("GrooveList").innerHTML = "";
      }
    } catch (err) {
      console.error("è¼‰å…¥é¸é …å¤±æ•—ï¼š", err);
    }
  });

  // ğŸ”€ é¡¯ç¤º/éš±è—å°æ‡‰æ¬„ä½ï¼ˆä¾ç…§é¡åˆ¥ï¼‰
  function toggleInputGroups(category) {
    const show = (id, condition) => {
      const group = document.getElementById(id).closest(".input-group");
      group.style.display = condition ? "flex" : "none";
      const input = group.querySelector("input, select, textarea");
      if (input) condition ? input.setAttribute("required", "required") : input.removeAttribute("required");
    };

    show("groove", category === "A.åˆ€ç‰‡");
    show("size", category === "A.åˆ€ç‰‡");
    show("shape", category !== "D.å…¶ä»–");
    show("material", category !== "D.å…¶ä»–");
  }

  // ğŸ§¼ æ¸…ç©ºè¡¨å–®å…§å®¹ï¼ˆä¿ç•™æ—¥æœŸï¼‰
  function resetFormInputs() {
    const form = document.getElementById("stockForm");
    [...form.elements].forEach(el => {
      if (el.id !== "date" && el.tagName === "INPUT") {
        el.value = "";
      }
    });
  }

  // ğŸ“ è™•ç†å–®åƒ¹èˆ‡æ•¸é‡è¼¸å…¥ â†’ è‡ªå‹•è¨ˆç®—ç¸½åƒ¹
  function updateTotalPrice() {
    const unitPrice = parseFloat(document.getElementById('unit_price').value);
    const quantity = parseFloat(document.getElementById('quantity').value);
    const total = (!isNaN(unitPrice) && !isNaN(quantity)) ? unitPrice * quantity : 0;
    document.getElementById('total_price').value = '$' + total.toFixed(0);
  }

  // ğŸ§© è¨­å®šå“åçµ„åˆè¦å‰‡ï¼ˆåƒ…é™ A.åˆ€ç‰‡ é¡åˆ¥ï¼‰
  function updateSpec() {
    if (categoryEl.value !== "A.åˆ€ç‰‡") return;

    const shape = shapeEl.value.trim();
    const size = sizeEl.value.trim();
    const groove = grooveEl.value.trim();
    const material = materialEl.value.trim();

    if (shape && material) {
      const parts = [shape];
      if (size) parts.push(size);
      if (groove) parts.push(groove);
      parts.push(material);
      specEl.value = parts.join("-");
    }
  }

  // ğŸ§­ è¡¨å–®é€å‡ºè™•ç†ï¼ˆPOSTï¼‰
  function setupFormListeners() {
    document.getElementById('unit_price').addEventListener('input', updateTotalPrice);
    document.getElementById('quantity').addEventListener('input', updateTotalPrice);

    // ğŸš« é˜²æ­¢ Enter æäº¤
    document.getElementById('stockForm').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        const tag = event.target.tagName.toLowerCase();
        if (tag === 'input' || tag === 'textarea') {
          event.preventDefault();
        }
      }
    });

    document.getElementById('stockForm').addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      if (data.date) {
        const d = new Date(data.date);
        data.date = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
      }

      console.log("é€å‡ºçš„è³‡æ–™ï¼š", data);
      showLoading();

      fetch(scriptUrl, {
        method: 'POST',
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          hideLoading();
          if (result.success) {
            const stock = result.stock;
            const tableHtml = `
              <table class="table table-bordered mt-3">
                <thead class="table-dark">
                  <tr>
                    <th>ç·¨è™Ÿ</th>
                    <th>å“åè¦æ ¼</th>
                    <th>æè³ª</th>
                    <th>å» ç‰Œ</th>
                    <th>æ•¸é‡</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${stock.ç·¨è™Ÿ}</td>
                    <td>${stock["å“åè¦æ ¼"]}</td>
                    <td>${stock.æè³ª}</td>
                    <td>${stock.å» ç‰Œ}</td>
                    <td>${stock.æ•¸é‡}</td>
                  </tr>
                </tbody>
              </table>`;
            document.getElementById("result").innerHTML = tableHtml;
          }
        })
        .catch(err => {
          hideLoading();
          console.error("é€å‡ºå¤±æ•—ï¼š", err);
        });
    });

    // ğŸ§  ä¾æ“š shape è¼¸å…¥ï¼Œè‡ªå‹•è¼‰å…¥å°æ‡‰å°ºå¯¸æ¸…å–®
    shapeEl.addEventListener("input", async () => {
      const category = categoryEl.value;
      const shape = shapeEl.value.trim();

      if (!category || !shape) return;

      try {
        const res = await fetch(`${scriptUrl}?page=inventory&category=${encodeURIComponent(category)}&shape=${encodeURIComponent(shape)}`);
        const data = await res.json();
        const sizeList = data.size || [];

        updateDatalist("sizeList", sizeList);
      } catch (err) {
        console.error("è¼‰å…¥å°ºå¯¸å¤±æ•—ï¼š", err);
      }
    });

    // ç›£è½æ¬„ä½è¼¸å…¥çµ„åˆè¦æ ¼
    [shapeEl, sizeEl, grooveEl, materialEl].forEach(el => {
      el.addEventListener("input", updateSpec);
    });
  }

  // ğŸ”„ é¡¯ç¤ºè¼‰å…¥å‹•ç•«
  function showLoading() {
    document.getElementById("loading").style.display = "block";
    document.getElementById("result").innerHTML = "";
  }

  // âŒ éš±è—è¼‰å…¥å‹•ç•«
  function hideLoading() {
    document.getElementById("loading").style.display = "none";
  }

  // ğŸ” è¨­å®šå“åè¼¸å…¥æ¬„ä½çš„è‡ªå‹•æç¤ºåŠŸèƒ½ï¼ˆå¾ allSpecs æ¯”å°ï¼‰
  function setupSpecSuggestion() {
    const suggestionBox = document.getElementById("specSuggestions");

    specEl.addEventListener("input", () => {
      const keyword = specEl.value.trim().toUpperCase();
      suggestionBox.innerHTML = "";

      if (!keyword || allSpecs.length === 0) {
        suggestionBox.style.display = "none";
        return;
      }

      const matches = allSpecs.filter(spec =>
        spec.toUpperCase().includes(keyword)
      ).slice(0, 10);

      if (matches.length === 0) {
        suggestionBox.style.display = "none";
        return;
      }

      matches.forEach(spec => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.textContent = spec;
        li.onclick = () => {
          specEl.value = spec;
          suggestionBox.style.display = "none";
        };
        suggestionBox.appendChild(li);
      });

      suggestionBox.style.display = "block";
    });

    // é»æ“Šç•«é¢å…¶ä»–åœ°æ–¹æ™‚éš±è—æç¤ºæ¸…å–®
    document.addEventListener("click", e => {
      if (!suggestionBox.contains(e.target) && e.target !== specEl) {
        suggestionBox.style.display = "none";
      }
    });
  }
</script>

</body>
</html>
