<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CNC 加工數量查詢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="共用風格.css">

    <style>
        body {
            background-image: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
        }
        .input-group-text {
            color: rgb(11, 148, 4);
        }

        .btn-藍 {
            width:100%;
            font-size:20px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        .btn-藍 {
            width:100%;
            font-size:20px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        .btn-紫 {
            width:100%;
            font-size:20px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        /* 🧮 最後一列（總計列）樣式 */
        #result tr:last-child td {
            font-weight: bold;         /* 字體加粗 */
            background-color: #ffe345; /* 顯眼的黃底 */
            font-size:16px;
        }

    </style>
</head>

<body>
  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="首頁.html">
        <img src="https://kuanlin1218.github.io/CNC_QS/CNC%E5%8A%A0%E5%B7%A5%E6%95%B8%E9%87%8F%E7%B5%B1%E8%A8%88_ver_2/logo_S.png" alt="Logo" class="navbar-logo">
        詮栩CNC雲端系統
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="切換導覽列">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="首頁.html">🏠 首頁</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="刀具入庫.html">🛠️ 刀具入庫</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="刀具查詢.html">🔍 刀具查詢</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="加工數量登記.html">✍️ 加工數量登記</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="加工數量查詢.html">📊 加工數量查詢</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

    <div class="container">
        <form id="myForm2" onsubmit="searchValues(event)">
            <h2 class="text-center">📊 加工數量查詢 📊</h2><hr>
            <div class="input-group my-3">
                <span class="input-group-text">開始日期</span>
                <input type="date" id="dt1" class="form-control custom" required>
            </div>
            <div class="input-group my-3">
                <span class="input-group-text">結束日期</span>
                <input type="date" id="dt2" class="form-control custom" required>
            </div>
            <div class="input-group my-3">
                <span class="input-group-text">產品編號</span>
                <select id="pd2" class="form-select custom" required></select>
            </div>
            <button type="submit" class="btn btn-藍">日期區間查詢</button>
            <button type="button" class="btn btn-紫 mt-2" onclick="searchlastValues(event)">查詢最後一筆</button>
        </form>
        <hr>
        <!-- 顯示表格內容 -->
        <div class="table-container" id="result"></div>
        <br>
    </div>

    <script>

        window.onload = function () {
            setYesterdayDate('dt1');
            setYesterdayDate('dt2');
            loadProductList(); // 用 fetch 載入產品編號
        };

        // 設定預設日期為昨天
        function setYesterdayDate(inputId) {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            document.getElementById(inputId).value = `${yyyy}-${mm}-${dd}`;
        }

        // 載入產品清單
        function loadProductList() {
            fetch(`${scriptUrl}?page=production_entry&type=product`)
            .then(res => res.json())
            .then(data => {
                const pdSelect = document.getElementById("pd2");
                pdSelect.innerHTML = '<option value=""></option>';
                data.forEach(item => {
                    pdSelect.appendChild(new Option(item, item));
                });
            })
            .catch(err => console.error("載入產品失敗", err));
        }

        function searchValues(event) {
            event.preventDefault();
            const dt1 = document.getElementById("dt1").value;
            const dt2 = document.getElementById("dt2").value;
            const pd = document.getElementById("pd2").value;
            if (!pd) return alert("請選擇產品編號");

            const d1 = new Date(dt1);
            const d2 = new Date(dt2);
            const f1 = `${d1.getFullYear()}/${d1.getMonth() + 1}/${d1.getDate()}`;
            const f2 = `${d2.getFullYear()}/${d2.getMonth() + 1}/${d2.getDate()}`;

            fetch(`${scriptUrl}?page=production_query&pd=${encodeURIComponent(pd)}&dt1=${f1}&dt2=${f2}`)
            .then(res => res.json())
            .then(rows => {
                displayTable(rows);
            })
            .catch(() => alert("查詢失敗"));
        }

        function searchlastValues(event) {
            event.preventDefault();
            const pd = document.getElementById("pd2").value;
            if (!pd) return alert("請選擇產品編號");

            fetch(`${scriptUrl}?page=production_query&mode=latest&pd=${encodeURIComponent(pd)}`)
            .then(res => res.json())
            .then(data => {
                displayTable(data);
            })
            .catch(() => alert("查詢失敗"));
        }

        function displayTable(data, emptyMessage = "沒有符合條件的資料") {
            const resultDiv = document.getElementById("result");

            if (!data || data.length === 0) {
                resultDiv.innerHTML = `<p>${emptyMessage}</p>`;
                return;
            }

            const headers = ["日期", "產品編號", "數量"];
            let html = `<table class="table table-bordered table-striped"><thead><tr>`;
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += `</tr></thead><tbody>`;

            let total = 0;
            data.forEach(row => {
                html += `<tr>`;
                row.forEach((cell, i) => {
                html += `<td>${cell}</td>`;
                if (i === 2) total += parseInt(cell) || 0;
                });
                html += `</tr>`;
            });

            html += `<tr><td colspan="2">總數量</td><td>${total}</td></tr>`;
            html += `</tbody></table>`;
            resultDiv.innerHTML = html;
        }

        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            link.addEventListener('click', () => {
                const navbar = document.getElementById('navbarNav');
                if (navbar.classList.contains('show')) navbar.classList.remove('show');
            });
        });

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    window.scrollTo({ top: target.offsetTop - 50, behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>
